# Домашнее задание к занятию 5 "Тестирование roles"

## Подготовка к выполнению

|         Номер и описание задачи         | Описание выполняемых действий                                                | Скриншоты                             |
| :---------------------------------------------------------: | ------------------------------------------------------------------------------------------------------- | ---------------------------------------------- |
| 1. Установить molecule и его драйвера | Команда pip3 install molecule molecule_docker molecule_podman                                   | ![1735549611973](image/README/1735549611973.png) |
|    2. Спулить образ aragast/netology:latest    | это образ с podman, tox и несколькими пайтонами (3.7 и 3.9) внутри | ![1735549800518](image/README/1735549800518.png) |

## Основная часть

### Molecule

|                                                                           Номер и описание задачи                                                                           | Описание выполняемых действий                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Скриншоты                                                                                                                                                                                         |
| :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1. Выполнить команду<br />molecule test -s ubuntu_focal<br />внутри корневой директории <br />clickhouse-role. Изучить вывод команды | Выполнен переход в директорию установленной роли<br />clickhouse. Выполнена команда.<br />Для того, чтобы команда хотя бы запустилась<br />на последней версии molecule, потребовалось в файле<br />molecule.yml сценария убрать параметр playbooks в разделе<br />verifier.<br />После этих изменений тест все равно не смог выполниться успешно.<br />Инфраструктура поднялась, но подключиться к ней Ansible не смог.<br />Также были отображены иные ошибки/предупреждения.<br />Т.к. в данном домашнем задании предполагается использование<br />последней версии molecule а не конкретной, то от дальнейшего<br />разбора проблем было решено отказаться.<br />Поднять виртуальное окружение с зависимостями из самой роли с<br />ходу тоже, к сожалению, не удалось, т.к. эти зависимости довольно<br />давно не обновляются разработчиком, потому как сама роль на<br />данный момент находится в архиве. | ![1735555737320](image/README/1735555737320.png)<br />![1735555766989](image/README/1735555766989.png)<br />![1735556386013](image/README/1735556386013.png)<br />![1735556422094](image/README/1735556422094.png) |
|                  2. Перейти в каталог со своей ролью Vector<br />и создать сценарий тестирования по умолчанию                  | Т.к. моя роль подразумевает установку Vector и создания для него<br />юнита в systemd, а также учитывая то, что роль разрабатывалась, <br />в первую очередь под Ubuntu, принял решение использовать другой<br />драйвер для молекулы, а именно molecule-lxd и понизить версию <br />molecule до 4.0.4<br />Создал дефолтный сценарий поднятия LXC контейнеров на Ubuntu<br />и проигрывания на них роли.<br />Также доработал роль, чтобы можно было деплоить дефолтный<br />конфиг Vector, не требующий интегрции. Этот конфиг как раз нужен<br />для тестов.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ![1735576494910](image/README/1735576494910.png)                                                                                                                                                             |
|                                                  3. Добавить несколько инстансов<br />для тестирования                                                  | Добавил 2 инстанса для тестирования:<br />Ubuntu Focal<br />Ubuntu Jammy<br />Другие дистрибутивы не включил, потому как на момент выполнения<br />ДЗ LXD перешел под Canonical, что привело, в свою очередь,<br />к недоступности других дистрибутивов кроме Ubuntu в LXD.<br />Но, т.к. роль разрабатывалась под Ubuntu, проблем нет.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ![1735576676979](image/README/1735576676979.png)                                                                                                                                                             |
|                       4. Добавить несколько asserts для проверки<br />работоспособности Vector после установки.                       | Добавил несколько Asserts для проверки работоспособности<br />Vector после его установки.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ![1735576748133](image/README/1735576748133.png)                                                                                                                                                             |
|                         5. Запустить тестирование роли повторно.<br />Проверить успешность тестирования.                         | Запустил тест повторно при помощи molecule test.<br />Тестирование прошло успешно.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | ![1735576863386](image/README/1735576863386.png)<br />![1735576875195](image/README/1735576875195.png)<br />![1735576887891](image/README/1735576887891.png)<br />![1735576901947](image/README/1735576901947.png) |
|                                                6. Выпустить новый тэг роли после<br />добавления тестов                                                | Выпустил новую версию роли (v0.4.0)<br />https://github.com/Torrmund/ansible_vector_role/releases/tag/v0.4.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                            |

### Tox

|                                                                   Номер и описание задачи                                                                   | Описание выполняемых действий                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Скриншоты                                                                                                                                     |
| :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
|                                                        1. Добавить в реп файлы из<br />примера.                                                        | Файлы добавлены                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ![1735577771127](image/README/1735577771127.png)                                                                                                         |
| 2. Запустить докер контейнер<br />aragast/netology:latest<br />с примонтированием к нему<br />репозитория с ролью. | Потому как с использованием tox в контейнере<br />на моем окружении возникло множество проблем,<br />Принял решение использовать tox в виртуальном<br />окружении на моей рабочей станции.<br />Файл tox.ini и tox-requirements.txt скорректировал<br />с учетом используемого окружения.<br />Сценарий тестирования molecule также скорректировал,<br />а именно, перевел на драйвер lxd для корректной<br />работы роли.<br />На моей рабочей станции установлены разные версии<br />Python (3.8 и 3.10). | ![1735928320183](image/README/1735928320183.png)<br />![1735928335036](image/README/1735928335036.png)                                                     |
|                                                   3. Вызвать внутри контейнера<br />команду tox                                                   | Вызвана команда tox<br />Она не завершилась корректно, потому как не был создан<br />сценарий, указанный в команде вызова tox (сценарий<br />compatibility)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                        |
|                                              4. Создан легковесный сценарий<br />под драйвер lxd                                              | Создал упрощенную версию default сценария с названием<br />compatibility, чтобы он корректно запускался через <br />команду tox.<br />Сценарий предварительно был протестирован <br />через molecule.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | ![1735928548367](image/README/1735928548367.png)<br />![1735928562698](image/README/1735928562698.png)<br />![1735928575149](image/README/1735928575149.png) |
|                            5. Запустить команду tox.<br />Убедиться, что все отработало<br />успешно.                            | Запущен tox.<br />Созданы все необходимые (указанные в tox.ini)<br />виртуальные окружения.<br />Успешно пройдены тесты.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ![1735928799812](image/README/1735928799812.png)                                                                                                         |
|                                                              6. Выпустить новую версию роли                                                              | Ссылка на новую версию роли: [v0.5.0](https://github.com/Torrmund/ansible_vector_role/releases/tag/v0.5.0)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                        |
