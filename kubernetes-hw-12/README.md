# Домашнее задание к занятию "Установка Kubernetes"

## Подготовка к выполнению

Для развертывания кластера K8s будут создаваться ВМ в Yandex Compute Cloud

Пример развернутых ВМ:

![1741252164495](image/README/1741252164495.png)

Затем, на основе этих ВМ будет подниматься кластер K8s описанными далее способами.

## Задание 1

Установить кластер K8s с одной мастер нодой

1. Подготовка работы кластера из 5 нод: 1 мастер и 4 воркер ноды;
2. В качестве CRI - containerd;
3. Запуск etcd производить на мастер ноде;
4. Способ установки выбрать самостоятельно.

### Установка через kubeadm

| Номер и описание задачи                                                                                                                       | Описание выполняемых действий                                                                                                                                                                                                                                   | Скриншоты                                                                                                                                                                                         |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1. Создать ВМ для мастер ноды                                                                                                               | В Yandex Compute Cloud создал ВМ для control plane                                                                                                                                                                                                                             | ![1741275402002](image/README/1741275402002.png)                                                                                                                                                             |
| 2. Настроить ноду для установки k8s                                                                                                      | Внес изменения в конфигурацию ноды.<br />Установил необходимые пакеты.                                                                                                                                                             | ![1741275727492](image/README/1741275727492.png)                                                                                                                                                             |
| 3. Инициализировать кластер                                                                                                                | Вызвал команду инициализации кластера через<br />kubeadm                                                                                                                                                                                            | ![1741275811489](image/README/1741275811489.png)<br />![1741276059259](image/README/1741276059259.png)                                                                                                         |
| 4. Настроить локально kubectl                                                                                                                    | Настроил локально kubectl                                                                                                                                                                                                                                                  | ![1741276182027](image/README/1741276182027.png)                                                                                                                                                             |
| 5. Создать ВМ для воркер нод.                                                                                                                | В YCC создал 4 ВМ для worker нод                                                                                                                                                                                                                                            | ![1741276438633](image/README/1741276438633.png)                                                                                                                                                             |
| 6. Подготовить воркер ноды для<br />подключения к кластеру.                                                           | Внес необходимые изменения в конфигурацию всех<br />нод.<br />Установил необходимые пакеты.                                                                                                                          | ![1741276694794](image/README/1741276694794.png)<br />![1741276884439](image/README/1741276884439.png)<br />![1741277227272](image/README/1741277227272.png)<br />![1741277210859](image/README/1741277210859.png) |
| 7. Установить сетевой плагин<br />для обеспечения<br />сетевого взаимодействия между нодами | К сожалению, в этот момент заметил, что кластер<br />"упал". Какая-то проблема с развертыванием кластера<br />через kubeadm. Решить данную проблему пока не удалось. |                                                                                                                                                                                                            |



### Установка через kubespray

| Номер и описание задачи                                                                                           | Описание выполняемых действий                                                                                                                                                   | Скриншоты                                                                                                                                     |
| ------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1. Создать ВМ для master и worker нод                                                                                 | В YCC создал все необходимые ВМ                                                                                                                                                     | ![1741349916695](image/README/1741349916695.png)                                                                                                         |
| 2. На отдельной машине развернуть<br />kubespray                                                           | Выделил отдельную машину.<br />Склонировал репозиторий<br />kubespray.                                                                                         | ![1741350142442](image/README/1741350142442.png)                                                                                                         |
| 3. Создать виртуальное окружение.<br />Установить необходимые зависимости. | Создал виртуальное окружение.<br />Установил необходимые зависимости.                                                                             | ![1741350223998](image/README/1741350223998.png)<br />![1741350292017](image/README/1741350292017.png)                                                     |
| 4. Скопировать пример inventory и<br />скорректировать его под свои нужды.            | Скопировал пример inventory и<br />скорректировал его под свои нужды.                                                                                        | ![1741350369308](image/README/1741350369308.png)<br />![1741351215192](image/README/1741351215192.png)<br />![1741351706587](image/README/1741351706587.png) |
| 5. Запустить развертывание кластера                                                                     | Запустил развертывание кластера через<br />запуск плейбука cluster.yml<br /><br />Playbook проигрался.                                           | ![1741353859846](image/README/1741353859846.png)                                                                                                         |
| 6. Проверить состояние кластера                                                                             | Подключился к мастер ноде по ssh.<br />Настроил kubectl.<br /><br />Проверил состояние нод.<br /><br />Кластер поднялся успешно. | ![1741354022197](image/README/1741354022197.png)                                                                                                         |



### Установка через RKE2

| Номер и описание задачи                                            | Описание выполняемых действий                                                                                                                                                                                                                                                                                                                                                                       | Скриншоты                                                                                                                                     |
| -------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1. Создать ВМ для master и worker нод                                  | В YCC создал необходимые ВМ.                                                                                                                                                                                                                                                                                                                                                                               | ![1741354548686](image/README/1741354548686.png)                                                                                                         |
| 2. Установить на master ноду серверную<br />часть RKE2   | Установил серверную часть RKE2<br />по [инструкции](https://docs.rke2.io/install/quickstart)                                                                                                                                                                                                                                                                                                  | ![1741354940117](image/README/1741354940117.png)<br />![1741355067683](image/README/1741355067683.png)                                                     |
| 3. Установить на worker ноды клиентскую<br />часть RKE2 | Установил на воркер ноды клиентскую<br />часть по [инструкции](https://docs.rke2.io/install/quickstart) <br /><br />В конфигурации клиента указал IP адрес<br />мастер ноды и токен, полученный на мастер<br />ноде.<br /><br />Повторил установку на всех воркер нодах. | ![1741355511195](image/README/1741355511195.png)<br />![1741355434181](image/README/1741355434181.png)<br />![1741355418502](image/README/1741355418502.png) |
| 4. Проверить, что ноды добавились в кластер          | Подключился к master ноде.<br /><br />Проверил состояние нод.<br /><br />Кластер поднялся успешно.                                                                                                                                                                                                                                                                   | ![1741356507333](image/README/1741356507333.png)                                                                                                         |


## Задание 2

1. Установить кластер в режиме HA
2. Использовать нечетное количество мастре нод
3. Для cluster ip использовать keepalived или другой способ.

Для развертывания выбрал keepalived и kubespray

| Номер и описание задачи                                                                       | Описание выполняемых действий                                                                                                                                                             | Скриншоты                                                                                 |
| ----------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| 1. Создать ВМ для кластера.                                                                   | В YCC создал все необходимые ВМ:<br />3 ВМ для мастер нод<br />2 ВМ для воркер нод                                                                                | ![1741366855784](image/README/1741366855784.png)                                                     |
| 2. Установить keepalived на<br />master ноды.                                                     | На все мастер ноды установил и<br />сконфигурировал keepalived                                                                                                               | ![1741368032011](image/README/1741368032011.png)<br />![1741367860626](image/README/1741367860626.png) |
| 3. Подготовить инвентарь<br />для kubespray.<br />Развернуть кластер.     | Подготовил инвентарь для kubespray.<br />Скорректировал конфигурацию для<br />развертывания.<br /><br />Запустил развертывание. | ![1741368965478](image/README/1741368965478.png)<br />![1741370795921](image/README/1741370795921.png) |
| 4. Подключиться к кластеру.<br />Посмотреть состояние нод.             | Подключился к кластеру и посмотрел<br />состояние нод.                                                                                                                     | ![1741370872382](image/README/1741370872382.png)                                                     |
| 5. Выключить одну из master<br />нод. Посмотреть состояние кластера. | Выключил master-node-1.<br />Посмотрел состояние кластера.<br /><br />Кластер остался доступен.                                                              | ![1741371969417](image/README/1741371969417.png)                                                     |
