# Домашнее задание к занятию "Обновление приложений"

## Задание 1

Выбрать стратегию обновления приложения и описать выбор

### Условия

1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить
2. Ресурсы, выделенные для приложения, ограничены и нет возможности их увеличить
3. Запас по ресурсам в менее загруженный момент времени составляет 20%
4. Обновление мажорное, новые версии приложения не умеют работать со старыми
5. Необходимо объяснить выбор стратении приложения.

### Ответ

Главным ограничивающим фактором при выборе стратегии обновление будет являться тот факт, что новая версия приложения несовместима со старой.

Таким образом, самой приемлемой стратегией обновления будет - **Полное обновление (Recreate) в период минимальной нагрузки на приложение.**

**Обоснование выбора:**

* **Несовместимость версий:**
  Т.к. новая версия приложения несовместима со старой, параллельная работа экземпляров разных версий (как, например, в Blue-Green Deployment или в Rolling Update) с очень высокой долью вероятности может привести к сбоям в работе всего приложения. Например, данные или протоколы взаимодействия могут быть изменены, что сделает невозможным корректную обработку запросов, или при обновлении приложения проводится миграция БД и с новой версией схемы БД старая версия приложения не сможет работать.
* **Минимизация простоя:**
  Стратения Recreate предполагает остановку всех старых реплик перед запуском новых. Это приведет к непродолжительному downtime-у, но т.к. это мажорное обновление, получается что это единственный способ избежать конфликтов между версиями.
  * **Контроль времени простоя:** Обновление должно проводиться в момент наименьшей активности пользователей, чтобы минимизировать влияние на сервис.
  * **Использование запаса ресурсов:** В период минимальной нагрузки (когда свободно 20% ресурсов) останавливаем старые реплики и высвобождаем еще 80%. В итоге для создания реплик новой версии будет доступно 100% ресурсов, что позволит быстрее выполнить развертывание.
* **Ограниченные ресурсы:**
  Есть стратегии, требующие двукратного количества ресурсов для своей реализации (например Blue-Green). Для таких стратегий недостаточно выделенных ресурсов, потому как минимальная нагрузка на приложение уже 80%.

**Другие стратегии и причина отказа от них:**

* Rolling Update - Несовместимость новой и старой версий
* Canary Release - Несовместимость новой и старой версий. Даже один экземпляр новой версии может вызвать сбои во всем приложении.
* Blue-Green Deployment - Требует двукратного количества ресурсов, которых нет в таком объеме.

## Задание 2

1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно
3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным
4. Откатиться после неудачного обновления

### Решение

| Номер и описание задачи                                                                                                                                                                                   | Описание выполняемых действий                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Скриншоты                                                                                                                                     |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1. Создать Deployment приложения<br />с указанными контейнерами, версиями и<br />количеством реплик.                                                        | Описал манифест deployment'а.<br /><br />Применил манифест.<br /><br />Убедился что поды поднялись.                                                                                                                                                                                                                                                                                                                                                                                                                                                               | ![1741459610629](image/README/1741459610629.png)<br />![1741459626211](image/README/1741459626211.png)<br />![1741459689001](image/README/1741459689001.png) |
| 2. Обновить nginx до версии 1.20.<br />Сократить время обновления до минимума<br />при это приложение должно оставаться доступным. | Скорректировал стратегию обновления.<br /><br />Исходя из количества реплик - 5<br />изменяем параметры:<br />maxUnavailable = 4, чтобы один под оставался<br />всегда доступным для стабильности приложения<br />maxSurge=5 чтобы создавалось сразу 5 подов с <br />новой версией.<br /><br />Обновил манифест и применил его, запустив<br /> тем самым процесс обновления. | ![1741460320741](image/README/1741460320741.png)<br />![1741460405482](image/README/1741460405482.png)                                                     |
| 3. Попытаться обновить nginx до версии 1.28.0                                                                                                                                                       | Изменил версию nginx на 1.28.0 в манифесте.<br /><br />Применил измененный манифест.<br /><br />Получаем ошибку при создании новых подов<br />с версией nginx 1.28.0 потому как такая версия<br />nginx еще не вышла.<br /><br />При этом приложение осталось доступным на <br />одной поде, так как мы указали это в стратегии<br />обновления.                                                         | ![1741460726536](image/README/1741460726536.png)<br />![1741460808418](image/README/1741460808418.png)                                                     |
| 4. Откатиться после неудачного обновления.                                                                                                                                                 | Выполнил откат обновления.<br /><br />Откат выполнился успешно.<br /><br />Все манифесты выложил в директорию src/ex.2 <br />рядом с данным readme.                                                                                                                                                                                                                                                                                                                                                                              | ![1741461008758](image/README/1741461008758.png)                                                                                                         |

## Задание 3

1. Создать два deployment'а приложения nginx
2. При помощи разных ConfigMap сделать две версии приложения - веб-страницы.
3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.

### Решение

| Номер и описание задачи                                                                       | Описание выполняемых действий                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Скриншоты                                                                                                                                                                                                                                             |
| ----------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1. Создасть ConfigMap для приложений.                                                        | Описал манифесты ConfigMap.<br /><br />Применил манифесты.                                                                                                                                                                                                                                                                                                                                                                                                                   | ![1741461805915](image/README/1741461805915.png)<br />![1741461841636](image/README/1741461841636.png)<br />![1741461987439](image/README/1741461987439.png)                                                                                                         |
| 2. Создать деплойменты и svc для двух<br />версий приложения.           | Описал манифесты развертывания<br />двух версий приложения.<br />У каждой версии своя конфигурация.<br /><br />Применил манифесты.<br /><br />Убедился, что поды поднялись.                                                                                                                                                                                                            | ![1741462157798](image/README/1741462157798.png)<br />![1741462214073](image/README/1741462214073.png)<br />![1741462260411](image/README/1741462260411.png)<br />![1741462290289](image/README/1741462290289.png)<br />![1741462351350](image/README/1741462351350.png) |
| 3. С помощью ingress создать канареечный<br />деплоймент.                     | Описал манифест nginx ingress для<br />реализации канареечного деплоймента.<br />Реализовано так, что 90% трафика уходит<br />на v1 и 10% трафика на v2.<br />Управление этим соотношением<br />осуществляется через аннотацию<br />canary-weight<br /><br />Применил манифест.                                                            | ![1741464078896](image/README/1741464078896.png)<br />![1741464092347](image/README/1741464092347.png)<br />![1741464104682](image/README/1741464104682.png)                                                                                                         |
| 4. Проверить корректность работы<br />канареечного деплоймента. | Прописал себе в hosts запись для example.com.<br /><br />Открыл из браузера несколько раз example.com<br /><br />Удостоверился, что 10% трафика <br />уходит на 2 версию приложения.<br /><br />Канареечный деплоймент настроен успешно.<br /><br />Все манифесты выложил в директорию src/ex.3<br />рядом с данным readme. | ![1741464159185](image/README/1741464159185.png)<br />![1741464169708](image/README/1741464169708.png)                                                                                                                                                             |
