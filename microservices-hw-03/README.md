# Домашнее задание к занятию "Микросервисы. Подходы"

## Задание 1

### Постановка

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

* облачная система;
* система контроля версий Git;
* репозиторий на каждый сервис;
* запуск сборки по событию из системы контроля версий;
* запуск сборки по кнопке с указанием параметров;
* возможность привязать настройки к каждой сборке;
* возможность создания шаблонов для различных конфигураций сборок;
* возможность безопасного хранения секретных данных (пароли, ключи доступа);
* несколько конфигураций для сборки из одного репозитория;
* кастомные шаги при сборке;
* собственные докер-образы для сборки проектов;
* возможность развернуть агентов сборки на собственных серверах;
* возможность параллельного запуска нескольких сборок;
* возможность параллельного запуска тестов.

Обоснуйте свой выбор.

### Ответ

Сравним 2 известных набора инструментов для реализации решения:

* Gitlab
* Bitbucket + Teamcity/Jenkins (self-hosted в облаке) + Docker registry (self-hosted в облаке)

Рассмотрим Gitlab подробнее:

1. **Облачная система** : GitLab предлагает облачное решение (GitLab.com), а также возможность развертывания на собственных серверах (self-hosted GitLab).
2. **Система контроля версий Git** : GitLab полностью основан на Git и предоставляет все необходимые функции для управления репозиториями.
3. **Репозиторий на каждый сервис** : В GitLab можно создать отдельный репозиторий для каждого сервиса.
4. **Запуск сборки по событию из системы контроля версий** : GitLab CI/CD позволяет запускать сборки автоматически при событиях, таких как push, merge request и т.д.
5. **Запуск сборки по кнопке с указанием параметров** : GitLab поддерживает ручной запуск сборок с возможностью указания параметров.
6. **Возможность привязать настройки к каждой сборке** : В GitLab можно использовать `.gitlab-ci.yml` файл для определения настроек каждой сборки.
7. **Возможность создания шаблонов для различных конфигураций сборок** : GitLab позволяет создавать шаблоны для различных конфигураций сборок, которые можно переиспользовать в разных проектах.
8. **Возможность безопасного хранения секретных данных (пароли, ключи доступа)** : GitLab предоставляет механизм для безопасного хранения секретных данных через переменные окружения.
9. **Несколько конфигураций для сборки из одного репозитория** : В GitLab можно определить несколько конфигураций сборок в `.gitlab-ci.yml` файле.
10. **Кастомные шаги при сборке** : GitLab CI/CD позволяет определять кастомные шаги при сборке через `.gitlab-ci.yml`.
11. **Собственные докер-образы для сборки проектов** : GitLab CI/CD поддерживает использование собственных Docker-образов для сборки проектов.
12. **Возможность развернуть агентов сборки на собственных серверах** : GitLab Runner можно развернуть на собственных серверах для выполнения сборок.
13. **Возможность параллельного запуска нескольких сборок** : GitLab CI/CD поддерживает параллельное выполнение нескольких сборок.
14. **Возможность параллельного запуска тестов** : GitLab CI/CD позволяет запускать тесты параллельно, что ускоряет процесс тестирования.

Итог по Gitlab:

GitLab предоставляет все необходимые инструменты для управления исходным кодом, автоматизации сборок и развертывания, а также для безопасного хранения секретных данных. Его гибкость и мощные возможности CI/CD делают его отличным выбором для обеспечения процесса разработки, соответствующего указанным требованиям.

Рассмотрим подробнее стек Bitbucket + Teamcity/Jenkins (self-hosted в облаке) + Docker registry (self-hosted в облаке):

1. **Облачная система** : Bitbucket предоставляет облачное решение для хранения исходного кода. TeamCity и Jenkins могут быть развернуты как в облаке, так и на собственных серверах.
2. **Система контроля версий Git** : Bitbucket полностью основан на Git и предоставляет все необходимые функции для управления репозиториями.
3. **Репозиторий на каждый сервис** : В Bitbucket можно создать отдельный репозиторий для каждого сервиса.
4. **Запуск сборки по событию из системы контроля версий** : TeamCity и Jenkins могут быть настроены для автоматического запуска сборок при событиях в Bitbucket, таких как push или pull request.
5. **Запуск сборки по кнопке с указанием параметров** : TeamCity и Jenkins поддерживают ручной запуск сборок с возможностью указания параметров.
6. **Возможность привязать настройки к каждой сборке** : В TeamCity и Jenkins можно использовать конфигурационные файлы для определения настроек каждой сборки.
7. **Возможность создания шаблонов для различных конфигураций сборок** : TeamCity и Jenkins позволяют создавать шаблоны для различных конфигураций сборок, которые можно переиспользовать в разных проектах.
8. **Возможность безопасного хранения секретных данных (пароли, ключи доступа)** : TeamCity и Jenkins предоставляют механизмы для безопасного хранения секретных данных через переменные окружения или плагины для управления секретами.
9. **Несколько конфигураций для сборки из одного репозитория** : В TeamCity и Jenkins можно определить несколько конфигураций сборок для одного репозитория.
10. **Кастомные шаги при сборке** : TeamCity и Jenkins позволяют определять кастомные шаги при сборке через конфигурационные файлы или интерфейс.
11. **Собственные докер-образы для сборки проектов** : TeamCity и Jenkins поддерживают использование собственных Docker-образов для сборки проектов.
12. **Возможность развернуть агентов сборки на собственных серверах** : TeamCity и Jenkins позволяют развернуть агентов сборки на собственных серверах.
13. **Возможность параллельного запуска нескольких сборок** : TeamCity и Jenkins поддерживают параллельное выполнение нескольких сборок.
14. **Возможность параллельного запуска тестов** : TeamCity и Jenkins позволяют запускать тесты параллельно, что ускоряет процесс тестирования.

Итог по данному стеку:

Использование Bitbucket для управления исходным кодом, TeamCity или Jenkins для CI/CD и Docker Registry для хранения Docker-образов предоставляет гибкое и мощное решение для обеспечения процесса разработки. Эти инструменты хорошо интегрируются друг с другом и предоставляют все необходимые функции для автоматизации сборок, тестирования и развертывания, а также для безопасного хранения секретных данных.

Сравним два этих решения:

GitLab

**Преимущества:**

1. **Интеграция** : Все инструменты (система контроля версий, CI/CD, управление проектами) интегрированы в одну платформу.
2. **Простота использования** : Единый интерфейс для всех функций, что упрощает настройку и управление.
3. **Облачное решение** : GitLab.com предоставляет облачное решение, что избавляет от необходимости управлять инфраструктурой.
4. **Безопасность** : Встроенные механизмы для безопасного хранения секретных данных.
5. **Шаблоны и переиспользование** : Возможность создания шаблонов для конфигураций сборок.
6. **Параллельные сборки и тесты** : Поддержка параллельного выполнения сборок и тестов.
7. **Docker** : Поддержка использования Docker-образов для сборок.

**Недостатки:**

1. **Зависимость от одной платформы** : Все инструменты зависят от GitLab, что может быть недостатком в случае проблем с доступностью.
2. **Ограничения бесплатного плана** : Бесплатный план GitLab.com может иметь ограничения по количеству минут на сборки и другие ресурсы.

Bitbucket + TeamCity/Jenkins + Docker Registry

**Преимущества:**

1. **Гибкость** : Возможность выбора и настройки отдельных инструментов под конкретные нужды.
2. **Масштабируемость** : Легкость масштабирования отдельных компонентов (например, агентов сборки в Jenkins).
3. **Интеграция с другими инструментами** : Легкость интеграции с другими инструментами и сервисами.
4. **Параллельные сборки и тесты** : Поддержка параллельного выполнения сборок и тестов.
5. **Docker** : Поддержка использования Docker-образов для сборок.
6. **Безопасность** : Возможность использования различных плагинов и механизмов для безопасного хранения секретных данных.

**Недостатки:**

1. **Сложность настройки** : Требуется больше усилий для настройки и интеграции всех компонентов.
2. **Управление инфраструктурой** : Необходимость управления инфраструктурой для TeamCity/Jenkins и Docker Registry.
3. **Разрозненные интерфейсы** : Разные интерфейсы для управления различными инструментами, что может усложнить процесс управления.

Сравнительная таблица по ключевым аспектам:

| Аспект                                         | Gitlab                                                                                    | Bitbucket + TeamCity/Jenkins + Docker Registry                                                                               |
| ---------------------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| Интеграция                                 | Полная нативная<br />интеграция всех инструментов | Резделенные инструменты, требующие настройки интеграции                    |
| Простота использования          | Единый интерфейс                                                           | Разные интерфейсы для каждого инструмента.                                              |
| Облачное решение                      | Да (Gitlab.com)                                                                         | Частично (Bitbucket). Требуется настройка в облаке для CI/CD и<br />Container Registry. |
| Безопасность                             | Встроенные механизмы                                                   | Плагины и внешние инструменты                                                                      |
| Шаблоны и переиспользование | Да                                                                                      | Да, но требует дополнительной настройки                                                    |
| Параллельные сборки и тесты  | Да                                                                                      | Да                                                                                                                         |
| Масштабируемость                     | Ограничена лицензионным планом                                | Высокая. Зависит от настройки.                                                                      |

Общий вывод:

* **GitLab** : Подходит для команд, которые ищут интегрированное решение с минимальными усилиями по настройке и управлению. Отлично подходит для небольших и средних команд, которые хотят быстро начать работу.
* **Bitbucket + TeamCity/Jenkins + Docker Registry** : Подходит для команд, которым нужна высокая гибкость и масштабируемость, и которые готовы инвестировать время в настройку и управление инфраструктурой. Отлично подходит для крупных команд и проектов с особыми требованиями к CI/CD.

## Задание 2

### Постановка

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре. Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

* сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
* минимальные требования к приложениям, сбор логов из stdout;
* гарантированная доставка логов до центрального хранилища;
* обеспечение поиска и фильтрации по записям логов;
* обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
* возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

### Ответ

Сравним 2 известных и популярных решения:

* Стек ELK + Filebeat
* Стек PGL (Promtail + Grafana + Loki)

Рассмотрим подробнее стек ELK:

Компоненты решения:

1. **Filebeat** : Легкий агент для отправки логов из stdout приложений на Logstash или Elasticsearch.
2. **Logstash** : Инструмент для сбора, обработки и отправки логов в Elasticsearch.
3. **Elasticsearch** : Центральное хранилище для логов с возможностью поиска и фильтрации.
4. **Kibana** : Пользовательский интерфейс для визуализации и анализа логов.

Принципы взаимодействия:

**Сбор логов в центральное хранилище со всех хостов** :

* Filebeat устанавливается на каждом хосте и собирает логи из stdout приложений.
* Filebeat отправляет логи на Logstash или напрямую в Elasticsearch.

**Минимальные требования к приложениям, сбор логов из stdout** :

* Приложения должны выводить логи в stdout.
* Filebeat автоматически собирает эти логи и отправляет их в центральное хранилище.

**Гарантированная доставка логов до центрального хранилища** :

* Filebeat использует механизм подтверждения доставки (acknowledgment) для гарантированной доставки логов.
* Logstash может быть настроен на использование очередей (например, Redis или Kafka) для обеспечения надежности доставки.

**Обеспечение поиска и фильтрации по записям логов** :

* Elasticsearch предоставляет мощные возможности для поиска и фильтрации логов.
* Kibana предоставляет интерфейс для выполнения запросов и фильтрации данных.

**Обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов** :

* Kibana предоставляет удобный веб-интерфейс для поиска и анализа логов.
* Доступ к Kibana можно настроить для различных пользователей и ролей.

**Возможность дать ссылку на сохранённый поиск по записям логов** :

* Kibana позволяет сохранять поисковые запросы и дашборды, которые можно поделиться с другими пользователями через ссылки.

Рассмотрим подробнее стек PLG:

Компоненты решения:

1. **Promtail** : Агент для сбора логов из stdout приложений и отправки их в Loki.
2. **Loki** : Система для хранения логов, оптимизированная для работы с Grafana.
3. **Grafana** : Пользовательский интерфейс для визуализации и анализа логов.

Принципы взаимодействия:

**Сбор логов в центральное хранилище со всех хостов** :

* Promtail устанавливается на каждом хосте и собирает логи из stdout приложений.
* Promtail отправляет логи в Loki.

**Минимальные требования к приложениям, сбор логов из stdout** :

* Приложения должны выводить логи в stdout.
* Promtail автоматически собирает эти логи и отправляет их в центральное хранилище.

**Гарантированная доставка логов до центрального хранилища** :

* Promtail использует механизм подтверждения доставки (acknowledgment) для гарантированной доставки логов.
* Loki обеспечивает надежное хранение логов.

**Обеспечение поиска и фильтрации по записям логов** :

* Loki предоставляет возможности для поиска и фильтрации логов.
* Grafana предоставляет интерфейс для выполнения запросов и фильтрации данных.

**Обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов** :

* Grafana предоставляет удобный веб-интерфейс для поиска и анализа логов.
* Доступ к Grafana можно настроить для различных пользователей и ролей.

**Возможность дать ссылку на сохранённый поиск по записям логов** :

* Grafana позволяет сохранять поисковые запросы и дашборды, которые можно поделиться с другими пользователями через ссылки.

Сравнительная характеристика решений:

**ELK (Elasticsearch, Logstash, Kibana)**

**Преимущества:**

* **Мощные возможности поиска и фильтрации** : Elasticsearch предоставляет мощные возможности для поиска и фильтрации логов.
* **Интеграция** : Kibana предоставляет мощный интерфейс для визуализации и анализа логов.
* **Гибкость** : Поддержка различных источников данных и форматов логов через Logstash.

**Недостатки:**

* **Ресурсоемкость** : Elasticsearch может требовать значительных ресурсов для масштабирования.
* **Сложность настройки** : Требует настройки и управления несколькими компонентами.

**PLG (Promtail, Loki, Grafana)**

**Преимущества:**

* **Оптимизация для логов** : Loki оптимизирован для хранения логов и интеграции с Grafana.
* **Легковесность** : Loki может быть более легковесным по сравнению с Elasticsearch.
* **Интеграция с метриками** : Grafana предоставляет возможности для визуализации не только логов, но и других метрик.

**Недостатки:**

* **Ограниченные возможности поиска** : Loki может иметь менее мощные возможности поиска и фильтрации по сравнению с Elasticsearch.
* **Сложность настройки** : Требует настройки и управления несколькими компонентами.

**Вывод:**

* **ELK (Elasticsearch, Logstash, Kibana)** : Подходит для команд, которым нужны мощные возможности поиска и фильтрации логов, и которые готовы инвестировать ресурсы в настройку и управление инфраструктурой. Отлично подходит для крупных проектов с высокими требованиями к анализу логов.
* **PLG (Promtail, Loki, Grafana)** : Подходит для команд, которым нужна оптимизация для логов и интеграция с метриками, и которые ищут более легковесное решение. Отлично подходит для проектов, где важна интеграция логов и метрик в одном интерфейсе.

Выбор между этими двумя решениями зависит от конкретных потребностей команды и проекта.

## Задание 3

### Постановка

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре. Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

* сбор метрик со всех хостов, обслуживающих систему;
* сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
* сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
* сбор метрик, специфичных для каждого сервиса;
* пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
* пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

### Ответ

Для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре можно использовать стек Prometheus + Grafana. Этот стек предоставляет мощные инструменты для сбора, хранения и визуализации метрик. Рассмотрим, как это решение удовлетворяет указанным требованиям:

**Компоненты решения:**

1. **Prometheus** : Система мониторинга и сбора метрик с возможностью опроса различных источников данных.
2. **Node Exporter** : Экспортер метрик состояния ресурсов хостов (CPU, RAM, HDD, Network).
3. **cAdvisor** : Инструмент для сбора метрик потребляемых ресурсов для каждого контейнера (CPU, RAM, HDD, Network).
4. **Экспортеры для специфичных метрик сервисов** : Экспортеры для сбора метрик, специфичных для каждого сервиса (например, экспортеры для баз данных, очередей сообщений и т.д.).
5. **Grafana** : Пользовательский интерфейс для визуализации и анализа метрик.

**Принципы взаимодействия:**

**Сбор метрик со всех хостов, обслуживающих систему** :

* Prometheus опрашивает Node Exporter, установленный на каждом хосте, для сбора метрик состояния ресурсов хостов.
* Prometheus опрашивает cAdvisor, установленный на каждом хосте, для сбора метрик потребляемых ресурсов для каждого контейнера.

**Сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network** :

* Node Exporter собирает метрики состояния ресурсов хостов и предоставляет их Prometheus.

**Сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network** :

* cAdvisor собирает метрики потребляемых ресурсов для каждого контейнера и предоставляет их Prometheus.

**Сбор метрик, специфичных для каждого сервиса** :

* Специфичные экспортеры (например, для баз данных, очередей сообщений) собирают метрики и предоставляют их Prometheus.

**Пользовательский интерфейс с возможностью делать запросы и агрегировать информацию** :

* Grafana предоставляет интерфейс для выполнения запросов к Prometheus и агрегирования информации.

**Пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы** :

* Grafana позволяет настраивать дашборды для визуализации метрик и отслеживания состояния системы.

**Обоснование выбора:**

1. **Централизованный сбор метрик** : Prometheus собирает метрики со всех хостов и сервисов, обеспечивая централизованный сбор данных.
2. **Сбор метрик состояния ресурсов хостов** : Node Exporter предоставляет метрики состояния ресурсов хостов (CPU, RAM, HDD, Network).
3. **Сбор метрик потребляемых ресурсов для каждого сервиса** : cAdvisor собирает метрики потребляемых ресурсов для каждого контейнера (CPU, RAM, HDD, Network).
4. **Сбор специфичных метрик сервисов** : Экспортеры для специфичных метрик сервисов (например, для баз данных) обеспечивают сбор необходимых данных.
5. **Пользовательский интерфейс** : Grafana предоставляет мощный интерфейс для визуализации и анализа метрик, а также для настройки дашбордов.
6. **Гибкость и масштабируемость** : Prometheus и Grafana легко масштабируются и интегрируются с различными источниками данных.

Это решение обеспечивает надежный и масштабируемый способ сбора, хранения и анализа метрик состояния хостов и сервисов в микросервисной архитектуре.
